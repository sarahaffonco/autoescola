{% extends 'base.html' %}

{% block title %}Veículo do Instrutor{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 bg-gray-50">
  <div class="max-w-3xl w-full">
    <div class="text-center mb-8">
      <div class="w-16 h-16 mx-auto rounded-xl bg-gradient-to-r from-yellow-500 to-yellow-600 flex items-center justify-center shadow-glow mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13l2-2m0 0l7-7 7 7M5 11v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6" />
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-gray-900">Veículo do Instrutor</h1>
      <p class="text-gray-600">Gerencie os dados do veículo utilizado nas aulas</p>
    </div>

    {% if messages %}
    <div class="mb-6 space-y-2">
      {% for message in messages %}
      <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="bg-white rounded-2xl shadow-card p-8">
      <form method="post" class="space-y-6" id="vehicleForm">
        {% csrf_token %}
        {% if editing_vehicle %}
        <input type="hidden" name="vehicle_id" value="{{ editing_vehicle.id }}">
        <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-800">Editando veículo {{ editing_vehicle.plate }}.</div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Placa *</label>
            <input type="text" name="plate" id="id_plate" value="{{ form.plate.value|default:form.instance.plate|default:'' }}" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all" placeholder="ABC1D23 ou AAA-1234" maxlength="8" required>
            {% if form.plate.errors %}<p class="mt-1 text-sm text-red-600">{{ form.plate.errors.0 }}</p>{% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">RENAVAM *</label>
            <input type="text" name="renavam" id="id_renavam" value="{{ form.renavam.value|default:form.instance.renavam|default:'' }}" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all" placeholder="11 dígitos" maxlength="11" required>
            <div class="mt-1 flex justify-between">
              <span class="text-sm text-gray-500">Digite 11 dígitos</span>
              <span id="renavamCounter" class="text-sm text-gray-500">(0/11)</span>
            </div>
            {% if form.renavam.errors %}<p class="mt-1 text-sm text-red-600">{{ form.renavam.errors.0 }}</p>{% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Marca *</label>
            <input type="text" name="make" id="id_make" value="{{ form.make.value|default:form.instance.make|default:'' }}" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all" placeholder="Ex.: Chevrolet" required>
            {% if form.make.errors %}<p class="mt-1 text-sm text-red-600">{{ form.make.errors.0 }}</p>{% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Modelo *</label>
            <input type="text" name="model" id="id_model" value="{{ form.model.value|default:form.instance.model|default:'' }}" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all" placeholder="Ex.: Onix 1.0" required>
            {% if form.model.errors %}<p class="mt-1 text-sm text-red-600">{{ form.model.errors.0 }}</p>{% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Cor *</label>
            <input type="text" name="color" id="id_color" value="{{ form.color.value|default:form.instance.color|default:'' }}" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all" placeholder="Ex.: Prata" required>
            {% if form.color.errors %}<p class="mt-1 text-sm text-red-600">{{ form.color.errors.0 }}</p>{% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Ano *</label>
            <input type="number" name="year" id="id_year" value="{{ form.year.value|default:form.instance.year|default:'' }}" min="1960" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all" placeholder="Ex.: 2022" required>
            {% if form.year.errors %}<p class="mt-1 text-sm text-red-600">{{ form.year.errors.0 }}</p>{% endif %}
          </div>

          <div class="md:col-span-2">
            <label class="inline-flex items-center">
              <input type="checkbox" name="dual_control" id="id_dual_control" class="w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500" {% if form.dual_control.value or form.instance.dual_control %}checked{% endif %}>
              <span class="ml-3 text-gray-700">Possui acionamento duplo (pedais no passageiro)</span>
            </label>
          </div>

          <div class="md:col-span-2">
            <label class="inline-flex items-center">
              <input type="checkbox" name="adapted_pcd" id="id_adapted_pcd" class="w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500" {% if form.adapted_pcd.value or form.instance.adapted_pcd %}checked{% endif %}>
              <span class="ml-3 text-gray-700">Veículo adaptado para PCD</span>
            </label>
          </div>
        </div>

        {% if vehicles %}
        <div class="mt-8 border-t border-gray-200 pt-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Veículos cadastrados</h3>
          <div class="space-y-3">
            {% for vehicle in vehicles %}
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 p-4 rounded-xl border border-gray-200">
              <div class="text-gray-800">
                <span class="font-semibold">{{ vehicle.make }} {{ vehicle.model }}</span> — {{ vehicle.plate }} · {{ vehicle.year }} · {{ vehicle.color }}
                <span class="text-sm text-gray-500 block">Duplo: {{ vehicle.dual_control|yesno:"Sim,Não" }} · PCD: {{ vehicle.adapted_pcd|yesno:"Sim,Não" }}</span>
              </div>
              <div class="flex gap-3 justify-end">
                <a href="?vehicle_id={{ vehicle.id }}" class="px-4 py-2 text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">Editar</a>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-6">
          <a href="{% url 'instrutor_dashboard' %}" class="px-6 py-3 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all text-center">Voltar</a>
          <div class="flex flex-col sm:flex-row gap-3 justify-end">
            <button type="submit" name="action" value="save_add_another" class="px-6 py-3 border border-yellow-500 text-yellow-700 font-medium rounded-lg hover:bg-yellow-50 transition-all text-center">Salvar e adicionar outro veículo</button>
            <button type="submit" name="action" value="save" class="px-8 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-medium rounded-lg hover:opacity-90 transition-all shadow-card text-center">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const plateInput = document.getElementById('id_plate');
    if (plateInput) {
      plateInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
        if (e.target.value.length > 8) e.target.value = e.target.value.substring(0, 8);
      });
    }

    const renInput = document.getElementById('id_renavam');
    if (renInput) {
      renInput.addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, '');
        if (v.length > 11) v = v.substring(0, 11);
        e.target.value = v;
        const c = document.getElementById('renavamCounter');
        if (c) {
          c.textContent = `(${v.length}/11)`;
          c.className = `text-sm ${v.length === 11 ? 'text-green-600' : 'text-gray-500'}`;
        }
      });
    }
  });
</script>
{% endblock %}
