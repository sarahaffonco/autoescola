{% extends 'base.html' %}

{% block title %}Cadastro de Aluno - AutoEscola{% endblock %}

{% block extra_css %}
<style>
    /* Estilo para radio buttons de categoria de CNH */
    .license-option input[type="radio"]:checked + div {
        border-color: rgb(34, 197, 94) !important;
        background-color: rgb(240, 253, 244) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .license-option input[type="radio"]:checked + div .bg-green-100 {
        background-color: rgb(187, 247, 208) !important;
    }
    
    .license-option input[type="radio"]:checked + div p {
        color: rgb(22, 101, 52);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pt-20 pb-12">
    <div class="container mx-auto px-4 max-w-5xl">
        <!-- Cabe√ßalho -->
        <div class="text-center mb-12 animate-fade-in">
            <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-blue-600 via-blue-500 to-indigo-500 flex items-center justify-center shadow-glow mb-6">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Cadastro de Aluno</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">Mesmo fluxo visual do agendamento: cards com bordas coloridas, √≠cones e destaques em tons de azul.</p>
        </div>

        <!-- Formul√°rio -->
        <div class="bg-white rounded-2xl shadow-card p-8 space-y-8">
            <!-- Mensagens de erro -->
            {% if messages %}
            <div class="mb-6 space-y-2">
                {% for message in messages %}
                <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="studentForm">
                {% csrf_token %}
                
                <!-- Campo oculto para role -->
                <input type="hidden" name="role" value="aluno">

                <!-- Se√ß√£o 1: Dados de Acesso -->
                <div class="mb-6 rounded-xl border border-blue-200 bg-blue-50/60 p-6 shadow-inner">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white shadow-card flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase text-blue-700">Passo 1</p>
                                <h2 class="text-xl font-bold text-gray-900">Dados de Acesso</h2>
                            </div>
                        </div>
                        <span class="text-xs font-medium text-blue-700 bg-blue-100 px-3 py-1 rounded-full">Seguro e privado</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Nome de Usu√°rio -->
                        <div>
                            <label for="id_username" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Nome de Usu√°rio *
                            </label>
                            <input type="text" 
                                   name="username" 
                                   value="{{ form.username.value|default:'' }}"
                                   id="id_username" 
                                   value="{{ form.username.value|default:'' }}"
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="escolha_um_usuario">
                            {% if form.username.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.username.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Email -->
                        <div>
                            <label for="id_email" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m8-4H8m2 8h8M4 6h16a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z"></path>
                                </svg>
                                Email *
                            </label>
                            <input type="email" 
                                   name="email" 
                                   value="{{ form.email.value|default:'' }}"
                                   id="id_email" 
                                   value="{{ form.email.value|default:'' }}"
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="seu@email.com">
                            {% if form.email.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Senha -->
                        <div>
                            <label for="id_password1" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3V7a3 3 0 00-6 0v1c0 1.657 1.343 3 3 3zm6 0a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2h12z"></path>
                                </svg>
                                Senha *
                            </label>
                            <div class="relative">
                                <input type="password" 
                                       name="password1" 
                                       id="id_password1" 
                                       required
                                       class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-10"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <button type="button"
                                        data-toggle-password
                                        data-target="id_password1"
                                        class="absolute inset-y-0 right-3 flex items-center text-blue-600 hover:text-blue-800 focus:outline-none">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                            <!-- Checklist de requisitos de senha -->
                            <div class="mt-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <p class="text-xs font-semibold text-blue-900 mb-3">Requisitos da senha:</p>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2" id="password-length-check">
                                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-xs text-gray-600">M√≠nimo 8 caracteres</span>
                                    </div>
                                    <div class="flex items-center gap-2" id="password-upper-check">
                                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-xs text-gray-600">1 letra mai√∫scula</span>
                                    </div>
                                    <div class="flex items-center gap-2" id="password-special-check">
                                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-xs text-gray-600">1 caractere especial (!@#$%^&*)</span>
                                    </div>
                                </div>
                            </div>
                            {% if form.password1.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.password1.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Confirmar Senha -->
                        <div>
                            <label for="id_password2" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3V7a3 3 0 00-6 0v1c0 1.657 1.343 3 3 3zm6 0a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2h12z"></path>
                                </svg>
                                Confirmar Senha *
                            </label>
                            <div class="relative">
                                <input type="password" 
                                       name="password2" 
                                       id="id_password2" 
                                       required
                                       class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-10"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <button type="button"
                                        data-toggle-password
                                        data-target="id_password2"
                                        class="absolute inset-y-0 right-3 flex items-center text-blue-600 hover:text-blue-800 focus:outline-none">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                            {% if form.password2.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.password2.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o 2: Dados Pessoais -->
                <div class="mb-6 rounded-xl border border-blue-200 bg-blue-50/60 p-6 shadow-inner">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-white shadow-card flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold uppercase text-blue-700">Passo 2</p>
                            <h2 class="text-xl font-bold text-gray-900">Dados Pessoais</h2>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Nome Completo -->
                        <div class="md:col-span-2">
                            <label for="id_full_name" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                            <input type="text" 
                                   name="full_name" 
                                   value="{{ form.full_name.value|default:'' }}"
                                   id="id_full_name" 
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="Seu nome completo">
                        </div>

                        <!-- CPF -->
                        <div>
                            <label for="id_cpf" class="block text-sm font-medium text-gray-700 mb-2">CPF *</label>
                            <input type="text" 
                                   name="cpf" 
                                   value="{{ form.cpf.value|default:'' }}"
                                   id="id_cpf" 
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="000.000.000-00"
                                   maxlength="14">
                            <div class="mt-1 flex justify-between text-sm text-gray-600">
                                <span>Digite 11 d√≠gitos</span>
                                <span id="cpfCounter" class="font-medium text-blue-700">(0/11)</span>
                            </div>
                        </div>

                        <!-- RG -->
                        <div>
                            <label for="id_rg" class="block text-sm font-medium text-gray-700 mb-2">RG *</label>
                            <input type="text" 
                                   name="rg" 
                                   id="id_rg"
                                   value="{{ form.rg.value|default:'' }}" 
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="00.000.000-0"
                                   maxlength="20">
                            <div class="mt-1 flex justify-between text-sm text-gray-600">
                                <span>8-12 caracteres</span>
                                <span id="rgCounter" class="font-medium text-blue-700">(0 caracteres)</span>
                            </div>
                        </div>

                        <!-- Telefone -->
                        <div>
                            <label for="id_phone" class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                            <input type="tel" 
                                   name="phone" 
                                   id="id_phone" 
                                   value="{{ form.phone.value|default:'' }}"
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="(00) 00000-0000">
                        </div>

                        <!-- Data de Nascimento -->
                        <div>
                            <label for="id_birth_date" class="block text-sm font-medium text-gray-700 mb-2">Data de Nascimento *</label>
                            <input type="date" 
                                   name="birth_date" 
                                   value="{{ form.birth_date.value|default:'' }}"
                                   id="id_birth_date" 
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>

                        <!-- Identidade de G√™nero -->
                        <div>
                            <label for="id_gender_identity" class="block text-sm font-medium text-gray-700 mb-2">Identidade de G√™nero *</label>
                            <select name="gender_identity" id="id_gender_identity" required class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="">Selecione</option>
                                <option value="CF" {% if form.gender_identity.value == 'CF' %}selected{% endif %}>Cisg√™nero Feminino</option>
                                <option value="CM" {% if form.gender_identity.value == 'CM' %}selected{% endif %}>Cisg√™nero Masculino</option>
                                <option value="TM" {% if form.gender_identity.value == 'TM' %}selected{% endif %}>Homem Transg√™nero</option>
                                <option value="TW" {% if form.gender_identity.value == 'TW' %}selected{% endif %}>Mulher Transg√™nero</option>
                            </select>
                            {% if form.gender_identity.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.gender_identity.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o 2.5: Categoria de CNH -->
                <div class="mb-6 rounded-xl border border-green-200 bg-green-50/60 p-6 shadow-inner">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-white shadow-card flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20h10a2 2 0 002-2v-6H5v6a2 2 0 002 2zm0 0a2 2 0 100-4 2 2 0 000 4zm10 0a2 2 0 100-4 2 2 0 000 4zM9 12V8m6 0v4M3 10h18"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold uppercase text-green-700">Categoria de CNH</p>
                            <h2 class="text-xl font-bold text-gray-900">Qual categoria de CNH?</h2>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Categoria A -->
                        <label class="license-option cursor-pointer">
                            <input type="radio" 
                                   name="license_categories" 
                                   value="A" 
                                   {% if form.license_categories.value == 'A' %}checked{% endif %}
                                   required
                                   class="sr-only">
                            <div class="p-4 rounded-lg border-2 border-green-200 bg-white hover:border-green-400 hover:bg-green-50 transition-all text-center">
                                <div class="w-12 h-12 mx-auto mb-2 rounded-lg bg-green-100 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-900">Categoria A</p>
                                <p class="text-xs text-gray-600 mt-1">üèçÔ∏è Motocicleta</p>
                            </div>
                        </label>

                        <!-- Categoria B -->
                        <label class="license-option cursor-pointer">
                            <input type="radio" 
                                   name="license_categories" 
                                   value="B" 
                                   {% if form.license_categories.value == 'B' %}checked{% endif %}
                                   required
                                   class="sr-only">
                            <div class="p-4 rounded-lg border-2 border-green-200 bg-white hover:border-green-400 hover:bg-green-50 transition-all text-center">
                                <div class="w-12 h-12 mx-auto mb-2 rounded-lg bg-green-100 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20h10a2 2 0 002-2v-6H5v6a2 2 0 002 2zm0 0a2 2 0 100-4 2 2 0 000 4zm10 0a2 2 0 100-4 2 2 0 000 4z"></path>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-900">Categoria B</p>
                                <p class="text-xs text-gray-600 mt-1">üöó Carro</p>
                            </div>
                        </label>

                        <!-- Ambas as categorias -->
                        <label class="license-option cursor-pointer">
                            <input type="radio" 
                                   name="license_categories" 
                                   value="AB" 
                                   {% if form.license_categories.value == 'AB' %}checked{% endif %}
                                   required
                                   class="sr-only">
                            <div class="p-4 rounded-lg border-2 border-green-200 bg-white hover:border-green-400 hover:bg-green-50 transition-all text-center">
                                <div class="w-12 h-12 mx-auto mb-2 rounded-lg bg-green-100 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-900">Ambas</p>
                                <p class="text-xs text-gray-600 mt-1">üèçÔ∏èüöó A e B</p>
                            </div>
                        </label>
                    </div>
                    {% if form.license_categories.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.license_categories.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Se√ß√£o 3: Endere√ßo -->
                <div class="mb-6 rounded-xl border border-blue-200 bg-blue-50/60 p-6 shadow-inner">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-white shadow-card flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold uppercase text-blue-700">Passo 3</p>
                            <h2 class="text-xl font-bold text-gray-900">Endere√ßo</h2>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- CEP -->
                        <div>
                            <label for="id_cep" class="block text-sm font-medium text-gray-700 mb-2">CEP *</label>
                            <input type="text" 
                                   name="cep" 
                                   id="id_cep" 
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="00000-000"
                                   maxlength="9">
                            <div class="mt-1 flex justify-between text-sm text-gray-600">
                                <span>Digite 8 d√≠gitos</span>
                                <span id="cepCounter" class="font-medium text-blue-700">(0/8)</span>
                            </div>
                        </div>

                        <!-- Endere√ßo (auto preenchido) -->
                        <div class="md:col-span-2">
                            <label for="id_address" class="block text-sm font-medium text-gray-700 mb-2">Endere√ßo *</label>
                            <input type="text" 
                                   name="address" 
                                   id="id_address" 
                                   required
                                   readonly
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white/70 cursor-not-allowed transition-all">
                            <p class="mt-1 text-sm text-gray-600">Preenchido automaticamente ap√≥s o CEP ou edit√°vel se necess√°rio.</p>
                        </div>

                        <!-- N√∫mero e Complemento -->
                        <div>
                            <label for="id_address_number" class="block text-sm font-medium text-gray-700 mb-2">N√∫mero *</label>
                            <input type="text" 
                                   name="address_number" 
                                   id="id_address_number" 
                                   required
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>

                        <div>
                            <label for="id_address_complement" class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                            <input type="text" 
                                   name="address_complement" 
                                   id="id_address_complement"
                                   class="w-full px-4 py-3 rounded-lg border border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o 4: Documentos -->
                <div class="mb-6 rounded-xl border border-blue-200 bg-blue-50/60 p-6 shadow-inner">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-white shadow-card flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold uppercase text-blue-700">Passo 4</p>
                            <h2 class="text-xl font-bold text-gray-900">Documentos</h2>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Foto 3x4 -->
                        <div>
                            <label for="id_photo" class="block text-sm font-medium text-gray-700 mb-2">Foto 3x4 *</label>
                            <input type="file" 
                                   name="photo" 
                                   id="id_photo" 
                                   required
                                   accept=".jpg,.jpeg,.png,image/jpeg,image/png"
                                   class="w-full px-4 py-3 rounded-lg border-2 border-dashed border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <p class="mt-1 text-sm text-gray-600">Apenas JPG, JPEG ou PNG (m√°x. 5MB)</p>
                        </div>

                        <!-- RG digitalizado (obrigat√≥rio) -->
                        <div>
                            <label for="id_support_document_1" class="block text-sm font-medium text-gray-700 mb-2">RG digitalizado (frente e verso) *</label>
                            <input type="file" 
                                   name="support_document_1" 
                                   id="id_support_document_1"
                                   accept="image/*,.pdf,.doc,.docx"
                                   required
                                   class="w-full px-4 py-3 rounded-lg border-2 border-dashed border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <p class="mt-1 text-sm text-gray-600">Obrigat√≥rio: RG escaneado ou foto n√≠tida (m√°x. 10MB).</p>
                        </div>

                        <div>
                            <label for="id_support_document_2" class="block text-sm font-medium text-gray-700 mb-2">LADV (Licen√ßa para Aprendizagem de Dire√ß√£o Veicular)</label>
                            <input type="file" 
                                   name="support_document_2" 
                                   id="id_support_document_2"
                                   accept="image/*,.pdf,.doc,.docx"
                                   class="w-full px-4 py-3 rounded-lg border-2 border-dashed border-blue-200 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <p class="mt-1 text-sm text-gray-600">Opcional: LADV digitalizada (m√°x. 10MB).</p>
                        </div>
                    </div>
                </div>

                <!-- Termos e Condi√ß√µes -->
                <div class="mb-6 p-5 rounded-xl border border-blue-200 bg-blue-50/60 shadow-inner">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-white shadow-card flex items-center justify-center">
                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <label for="id_terms" class="flex items-start gap-3 text-sm text-gray-700">
                                <input type="checkbox" 
                                       name="terms" 
                                       id="id_terms" 
                                       required
                                       class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                <span>Declaro que todas as informa√ß√µes fornecidas s√£o verdadeiras e concordo com os <a href="#" class="text-blue-700 font-medium hover:underline">termos de uso</a> e <a href="#" class="text-blue-700 font-medium hover:underline">pol√≠tica de privacidade</a> da auto escola.</span>
                            </label>
                            {% if form.terms.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.terms.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Bot√µes -->
                <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <a href="{% url 'choice' %}" 
                       class="w-full sm:w-auto px-6 py-3 rounded-lg border border-blue-100 text-blue-800 font-medium bg-white hover:bg-blue-50 transition-all text-center shadow-card">
                        Voltar
                    </a>
                    <button type="submit" 
                            class="w-full sm:w-auto px-8 py-3 gradient-primary text-white font-medium rounded-lg hover:opacity-90 transition-all shadow-card">
                        Finalizar Cadastro
                    </button>
                </div>

                <!-- Link para Login -->
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <p class="text-gray-600">
                        J√° tem uma conta? 
                        <a href="{% url 'login' %}" class="text-blue-600 font-medium hover:underline">
                            Fa√ßa login aqui
                        </a>
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eyeOpen = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>`;
    const eyeClosed = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a10.06 10.06 0 012.293-4.02M6.18 6.18A9.969 9.969 0 0112 5c4.477 0 8.268 2.943 9.542 7a10.04 10.04 0 01-4.132 5.225M3 3l18 18"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.88 9.88a3 3 0 104.24 4.24"></path>
        </svg>`;

    // Toggle de senha com delega√ß√£o
    document.querySelectorAll('[data-toggle-password]').forEach(btn => {
        btn.setAttribute('aria-pressed', 'false');
        btn.innerHTML = eyeOpen;
    });
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-toggle-password]');
        if (!btn) return;
        e.preventDefault();
        const input = document.getElementById(btn.dataset.target);
        if (!input) return;
        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        btn.setAttribute('aria-pressed', String(isHidden));
        btn.innerHTML = isHidden ? eyeClosed : eyeOpen;
        input.focus();
    });

    // ============================================
    // 0. VALIDA√á√ÉO DE SENHA EM TEMPO REAL
    // ============================================
    const passwordInput = document.getElementById('id_password1');
    if (passwordInput) {
        const validatePassword = (password) => {
            const checks = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };
            return checks;
        };

        const updatePasswordChecks = () => {
            const checks = validatePassword(passwordInput.value);
            
            // Atualiza check de m√≠nimo 8 caracteres
            const lengthCheck = document.getElementById('password-length-check');
            if (lengthCheck) {
                const icon = lengthCheck.querySelector('svg');
                const span = lengthCheck.querySelector('span');
                if (checks.length) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-green-500');
                    span.classList.remove('text-gray-600');
                    span.classList.add('text-green-700', 'font-semibold');
                } else {
                    icon.classList.add('text-gray-400');
                    icon.classList.remove('text-green-500');
                    span.classList.add('text-gray-600');
                    span.classList.remove('text-green-700', 'font-semibold');
                }
            }
            
            // Atualiza check de letra mai√∫scula
            const upperCheck = document.getElementById('password-upper-check');
            if (upperCheck) {
                const icon = upperCheck.querySelector('svg');
                const span = upperCheck.querySelector('span');
                if (checks.uppercase) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-green-500');
                    span.classList.remove('text-gray-600');
                    span.classList.add('text-green-700', 'font-semibold');
                } else {
                    icon.classList.add('text-gray-400');
                    icon.classList.remove('text-green-500');
                    span.classList.add('text-gray-600');
                    span.classList.remove('text-green-700', 'font-semibold');
                }
            }
            
            // Atualiza check de caractere especial
            const specialCheck = document.getElementById('password-special-check');
            if (specialCheck) {
                const icon = specialCheck.querySelector('svg');
                const span = specialCheck.querySelector('span');
                if (checks.special) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-green-500');
                    span.classList.remove('text-gray-600');
                    span.classList.add('text-green-700', 'font-semibold');
                } else {
                    icon.classList.add('text-gray-400');
                    icon.classList.remove('text-green-500');
                    span.classList.add('text-gray-600');
                    span.classList.remove('text-green-700', 'font-semibold');
                }
            }
        };

        // Atualiza checks ao digitar
        passwordInput.addEventListener('input', updatePasswordChecks);
        
        // Executa ao carregar a p√°gina em caso de valor pr√©-preenchido
        updatePasswordChecks();
    }

    // ============================================
    // 1. M√ÅSCARA PARA CPF
    // ============================================
    const cpfInput = document.getElementById('id_cpf');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            // Aplica formata√ß√£o
            if (value.length > 9) {
                e.target.value = value.replace(/(\d{3})(\d{3})(\d{3})(\d)/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                e.target.value = value.replace(/(\d{3})(\d{3})(\d)/, '$1.$2.$3');
            } else if (value.length > 3) {
                e.target.value = value.replace(/(\d{3})(\d)/, '$1.$2');
            } else {
                e.target.value = value;
            }
            
            // Atualiza contador
            const counter = document.getElementById('cpfCounter');
            if (counter) {
                const digits = e.target.value.replace(/\D/g, '');
                counter.textContent = `(${digits.length}/11)`;
                counter.className = `text-sm ${digits.length === 11 ? 'text-green-600' : 'text-red-600'}`;
            }
        });
    }
    
    // ============================================
    // 2. M√ÅSCARA PARA RG
    // ============================================
    const rgInput = document.getElementById('id_rg');
    if (rgInput) {
        rgInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^A-Za-z0-9.-]/g, '');
            if (value.length > 20) value = value.substring(0, 20);
            
            const cleanValue = value.replace(/[^A-Za-z0-9]/g, '');
            
            // Aplica formata√ß√£o baseada no tipo
            if (cleanValue.length === 0) {
                e.target.value = value;
            } else if (/^[A-Za-z]{2}/.test(cleanValue)) {
                // Padr√£o com letras (ex: MG-12.345.678)
                if (cleanValue.length <= 2) {
                    e.target.value = cleanValue;
                } else if (cleanValue.length <= 4) {
                    e.target.value = cleanValue.replace(/([A-Za-z]{2})(\d)/, '$1-$2');
                } else if (cleanValue.length <= 7) {
                    e.target.value = cleanValue.replace(/([A-Za-z]{2})(\d{2})(\d)/, '$1-$2.$3');
                } else if (cleanValue.length <= 10) {
                    e.target.value = cleanValue.replace(/([A-Za-z]{2})(\d{2})(\d{3})(\d)/, '$1-$2.$3.$4');
                } else {
                    e.target.value = cleanValue.replace(/([A-Za-z]{2})(\d{2})(\d{3})(\d{3})/, '$1-$2.$3.$4');
                }
            } else if (/^\d+$/.test(cleanValue)) {
                // Padr√£o apenas n√∫meros (ex: 12.345.678-9)
                if (cleanValue.length <= 2) {
                    e.target.value = cleanValue;
                } else if (cleanValue.length <= 5) {
                    e.target.value = cleanValue.replace(/(\d{2})(\d)/, '$1.$2');
                } else if (cleanValue.length <= 8) {
                    e.target.value = cleanValue.replace(/(\d{2})(\d{3})(\d)/, '$1.$2.$3');
                } else {
                    e.target.value = cleanValue.replace(/(\d{2})(\d{3})(\d{3})(\d)/, '$1.$2.$3-$4');
                }
            } else {
                e.target.value = value;
            }
            
            // Atualiza contador
            const counter = document.getElementById('rgCounter');
            if (counter) {
                const alphanum = e.target.value.replace(/[^A-Za-z0-9]/g, '');
                counter.textContent = `(${alphanum.length} caracteres)`;
                counter.className = `text-sm ${alphanum.length >= 8 && alphanum.length <= 12 ? 'text-green-600' : 'text-red-600'}`;
            }
        });
    }
    
    // ============================================
    // 3. M√ÅSCARA PARA CEP
    // ============================================
    const cepInput = document.getElementById('id_cep');
    const addressInput = document.getElementById('id_address');
    
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.substring(0, 8);
            
            if (value.length > 5) {
                e.target.value = value.replace(/(\d{5})(\d)/, '$1-$2');
            } else {
                e.target.value = value;
            }
            
            // Atualiza contador
            const counter = document.getElementById('cepCounter');
            if (counter) {
                const digits = e.target.value.replace(/\D/g, '');
                counter.textContent = `(${digits.length}/8)`;
                counter.className = `text-sm ${digits.length === 8 ? 'text-green-600' : 'text-red-600'}`;
            }
        });
        
        // Busca autom√°tica de CEP
        cepInput.addEventListener('blur', async function() {
            const digits = this.value.replace(/\D/g, '');
            
            if (digits.length === 8 && addressInput) {
                try {
                    // Adiciona indicador de carregamento
                    this.classList.add('bg-gray-100');
                    
                    const response = await fetch(`https://viacep.com.br/ws/${digits}/json/`);
                    const data = await response.json();
                    
                    if (!data.erro) {
                        // Formata o endere√ßo
                        const formattedAddress = `${data.logradouro || ''}, ${data.bairro || ''}, ${data.localidade || ''} - ${data.uf || ''}`;
                        addressInput.value = formattedAddress.trim();
                        
                        // Remove readonly e permite edi√ß√£o
                        addressInput.readOnly = false;
                        addressInput.classList.remove('bg-gray-50', 'cursor-not-allowed');
                        addressInput.classList.add('bg-white', 'cursor-text');
                        
                        // Adiciona borda de sucesso
                        this.classList.remove('border-gray-300');
                        this.classList.add('border-green-500');
                        
                    } else {
                        throw new Error('CEP n√£o encontrado');
                    }
                } catch (error) {
                    console.error('Erro ao buscar CEP:', error);
                    
                    // Adiciona borda de erro
                    this.classList.remove('border-gray-300');
                    this.classList.add('border-red-500');
                    
                    // Mant√©m campo de endere√ßo vazio mas edit√°vel
                    addressInput.value = '';
                    addressInput.readOnly = false;
                    addressInput.classList.remove('bg-gray-50', 'cursor-not-allowed');
                    addressInput.classList.add('bg-white', 'cursor-text');
                    addressInput.placeholder = 'Digite o endere√ßo manualmente';
                } finally {
                    this.classList.remove('bg-gray-100');
                }
            }
        });
    }
    
    // ============================================
    // 4. M√ÅSCARA PARA TELEFONE
    // ============================================
    const phoneInput = document.getElementById('id_phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length <= 10) {
                if (value.length > 6) {
                    e.target.value = value.replace(/(\d{2})(\d{4})(\d)/, '($1) $2-$3');
                } else if (value.length > 2) {
                    e.target.value = value.replace(/(\d{2})(\d)/, '($1) $2');
                } else {
                    e.target.value = value;
                }
            } else {
                e.target.value = value.replace(/(\d{2})(\d{5})(\d)/, '($1) $2-$3');
            }
        });
    }
    
    // ============================================
    // 5. VALIDA√á√ÉO DE IDADE M√çNIMA (18 anos)
    // ============================================
    const birthDateInput = document.getElementById('id_birth_date');
    if (birthDateInput) {
        birthDateInput.addEventListener('change', function() {
            if (this.value) {
                const birthDate = new Date(this.value);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                const actualAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) 
                    ? age - 1 
                    : age;
                
                // Valida se √© maior de 18 anos
                if (actualAge >= 18) {
                    this.classList.remove('border-red-500');
                    this.classList.add('border-green-500');
                    
                    // Remove mensagem de erro se existir
                    const errorMsg = this.parentNode.querySelector('.age-error');
                    if (errorMsg) errorMsg.remove();
                } else {
                    this.classList.remove('border-green-500');
                    this.classList.add('border-red-500');
                    
                    // Adiciona mensagem de erro
                    let errorMsg = this.parentNode.querySelector('.age-error');
                    if (!errorMsg) {
                        errorMsg = document.createElement('p');
                        errorMsg.className = 'mt-1 text-sm text-red-600 age-error';
                        this.parentNode.appendChild(errorMsg);
                    }
                    errorMsg.textContent = `Idade m√≠nima de 18 anos. Voc√™ tem ${actualAge} anos.`;
                }
            }
        });
    }
    
    // ============================================
    // 6. VALIDA√á√ÉO DE FORMUL√ÅRIO
    // ============================================
    const form = document.getElementById('studentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            // Valida CPF
            if (cpfInput) {
                const cpfDigits = cpfInput.value.replace(/\D/g, '');
                if (cpfDigits.length !== 11) {
                    cpfInput.classList.add('border-red-500');
                    isValid = false;
                } else {
                    cpfInput.classList.remove('border-red-500');
                }
            }
            
            // Valida RG
            if (rgInput) {
                const rgAlphanum = rgInput.value.replace(/[^A-Za-z0-9]/g, '');
                if (rgAlphanum.length < 8 || rgAlphanum.length > 12) {
                    rgInput.classList.add('border-red-500');
                    isValid = false;
                } else {
                    rgInput.classList.remove('border-red-500');
                }
            }
            
            // Valida CEP
            if (cepInput) {
                const cepDigits = cepInput.value.replace(/\D/g, '');
                if (cepDigits.length !== 8) {
                    cepInput.classList.add('border-red-500');
                    isValid = false;
                } else {
                    cepInput.classList.remove('border-red-500');
                }
            }
            
            // Valida Telefone
            if (phoneInput) {
                const phoneDigits = phoneInput.value.replace(/\D/g, '');
                if (phoneDigits.length < 10) {
                    phoneInput.classList.add('border-red-500');
                    isValid = false;
                } else {
                    phoneInput.classList.remove('border-red-500');
                }
            }
            
            // Valida Data de Nascimento (idade m√≠nima)
            if (birthDateInput && birthDateInput.value) {
                const birthDate = new Date(birthDateInput.value);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                const actualAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) 
                    ? age - 1 
                    : age;
                
                if (actualAge < 18) {
                    birthDateInput.classList.add('border-red-500');
                    isValid = false;
                } else {
                    birthDateInput.classList.remove('border-red-500');
                }
            }
            
            // Valida Foto
            const photoInput = document.getElementById('id_photo');
            if (photoInput && !photoInput.files.length) {
                photoInput.classList.add('border-red-500');
                isValid = false;
            } else if (photoInput) {
                photoInput.classList.remove('border-red-500');
            }
            
            // Valida Termos
            const termsCheckbox = document.getElementById('id_terms');
            if (termsCheckbox && !termsCheckbox.checked) {
                const termsLabel = termsCheckbox.nextElementSibling;
                if (termsLabel) {
                    termsLabel.classList.add('text-red-600');
                }
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                
                // Rola para o primeiro erro
                const firstError = document.querySelector('.border-red-500, .text-red-600');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                
                alert('Por favor, corrija os campos destacados em vermelho.');
            }
        });
        
        // Remove valida√ß√£o ao digitar
        const allInputs = [cpfInput, rgInput, cepInput, phoneInput, birthDateInput];
        allInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    this.classList.remove('border-red-500');
                });
            }
        });
        
        // Remove valida√ß√£o da foto ao selecionar
        const photoInput = document.getElementById('id_photo');
        if (photoInput) {
            photoInput.addEventListener('change', function() {
                this.classList.remove('border-red-500');
            });
        }
        
        // Remove valida√ß√£o dos termos
        const termsCheckbox = document.getElementById('id_terms');
        if (termsCheckbox) {
            termsCheckbox.addEventListener('change', function() {
                const termsLabel = this.nextElementSibling;
                if (termsLabel) {
                    termsLabel.classList.remove('text-red-600');
                }
            });
        }
        
        // ============================================
        // 7. MANIPULA√á√ÉO DE CATEGORIA DE CNH
        // ============================================
        const licenseOptions = document.querySelectorAll('input[name="license_categories"]');
        licenseOptions.forEach(option => {
            option.addEventListener('change', function() {
                // Remove erro anterior, se existir
                const errorMsg = document.querySelector('[name="license_categories"]').parentNode.nextElementSibling;
                if (errorMsg && errorMsg.classList.contains('text-red-600')) {
                    errorMsg.remove();
                }
            });
        });
    }
    
});
</script>
{% endblock %}