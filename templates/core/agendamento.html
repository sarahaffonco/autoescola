{% extends 'base.html' %}

{% block title %}Agendar Aula - AutoEscola{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pt-20 pb-12">
    <div class="container mx-auto px-4 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-10 animate-fade-in">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                Agendar Aula Pr√°tica
            </h1>
            <p class="text-gray-600">
                Escolha a data, hor√°rio e instrutor para sua pr√≥xima aula
            </p>
        </div>

        <!-- Form -->
        <div class="bg-white rounded-2xl p-8 shadow-card">
            <form id="agendamento-form" method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Date Selection -->
                <div>
                    <label for="id_date" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Selecione a Data
                    </label>
                    <input type="date" 
                           name="date" 
                           id="id_date" 
                           required
                           min="{{ today|date:'Y-m-d' }}"
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                </div>

                <!-- Time Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Selecione o Hor√°rio
                    </label>
                    <select name="time" 
                            id="id_time" 
                            required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                        <option value="">Escolha um hor√°rio</option>
                        {% for slot in time_slots %}
                        <option value="{{ slot }}">{{ slot }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Vehicle Type -->
                <div>
                    <label for="id_vehicle_type" class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Tipo de Ve√≠culo
                    </label>
                    <select name="vehicle_type" 
                            id="id_vehicle_type" 
                            required
                            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                        <option value="">Escolha o tipo</option>
                        <option value="A">üèçÔ∏è Categoria A - Motocicleta</option>
                        <option value="B">üöó Categoria B - Carro</option>
                    </select>
                </div>

                <!-- Location Section -->
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        </svg>
                        Local de Encontro - Passo 1: CEP
                    </h3>
                    
                    <!-- CEP Input -->
                    <div class="flex gap-2">
                        <input type="text" 
                               name="cep" 
                               id="id_cep" 
                               placeholder="00000-000"
                               maxlength="9"
                               required
                               class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                               autocomplete="postal-code">
                        <button type="button" 
                                id="search-cep-btn"
                                class="px-4 py-3 bg-primary text-white font-medium rounded-lg hover:bg-opacity-90 transition-all flex items-center gap-2">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Buscar
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">Insira o CEP para encontrar instrutores pr√≥ximos e preencher o endere√ßo automaticamente</p>

                    <!-- Address fields -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                        <input type="text" 
                               name="rua" 
                               id="id_rua" 
                               placeholder="Rua"
                               readonly
                               class="px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-700">
                        <input type="text" 
                               name="numero" 
                               id="id_numero" 
                               placeholder="N√∫mero"
                               maxlength="10"
                               required
                               class="px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
                        <input type="text" 
                               name="bairro" 
                               id="id_bairro" 
                               placeholder="Bairro"
                               readonly
                               class="px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-700">
                        <input type="text" 
                               name="cidade" 
                               id="id_cidade" 
                               placeholder="Cidade"
                               readonly
                               class="px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-700">
                    </div>

                    <input type="text" 
                           name="estado" 
                           id="id_estado" 
                           placeholder="Estado"
                           maxlength="2"
                           readonly
                           class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-700 mt-3">

                    <!-- CEP Feedback -->
                    <div id="cep-error" class="hidden text-sm text-red-600 flex items-center gap-2 mt-3">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13 13H11V7h2m0 8H11v2h2M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path>
                        </svg>
                        <span id="cep-error-msg"></span>
                    </div>
                    <div id="cep-success" class="hidden text-sm text-green-600 flex items-center gap-2 mt-3">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path>
                        </svg>
                        <span>Endere√ßo encontrado! Agora selecione seu instrutor preferido.</span>
                    </div>
                </div>

                <!-- Instructor Filters Section -->
                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Passo 2: Escolha seu Instrutor
                    </h3>

                    <!-- Gender Filter -->
                    <div class="mb-4">
                        <div class="mt-3">
                            <label class="text-xs font-medium text-gray-600 mb-1 block">Prefer√™ncia de Identidade (opcional)</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                <button type="button" class="identity-filter px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-primary transition-all" data-identity="CF" data-map="F">CF ‚Ä¢ Cisg√™nero Feminino</button>
                                <button type="button" class="identity-filter px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-primary transition-all" data-identity="CM" data-map="M">CM ‚Ä¢ Cisg√™nero Masculino</button>
                                <button type="button" class="identity-filter px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-primary transition-all" data-identity="TM" data-map="M">TM ‚Ä¢ Homem Transg√™nero</button>
                                <button type="button" class="identity-filter px-3 py-2 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-primary transition-all" data-identity="TW" data-map="F">TW ‚Ä¢ Mulher Transg√™nero</button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Usamos a identidade para exibir; a busca considera o g√™nero correspondente.</p>
                        </div>
                    </div>

                    <!-- Instructor Selection -->
                    <div>
                        <label for="id_instructor" class="block text-sm font-medium text-gray-700 mb-2">Instrutores Dispon√≠veis</label>
                        <select name="instructor" 
                                id="id_instructor" 
                                required
                                disabled
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Busque um CEP primeiro...</option>
                        </select>
                        <p class="text-xs text-gray-600 mt-2">Selecione um instrutor pr√≥ximo a voc√™</p>
                    </div>
                </div>

                <!-- Vehicle Preferences Section -->
                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                    <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13h2l1 3h12l1-3h2M5 13l1-3h12l1 3M7 16h10a2 2 0 002-2V9a2 2 0 00-2-2H7a2 2 0 00-2 2v5a2 2 0 002 2z"></path>
                        </svg>
                        Passo 3: Selecione o Ve√≠culo e Prefer√™ncias
                    </h3>

                    <!-- Vehicle Selection -->
                    <div class="mb-4">
                        <label for="id_vehicle" class="block text-sm font-medium text-gray-700 mb-2">Modelo do Ve√≠culo</label>
                        <select name="vehicle"
                                id="id_vehicle"
                                disabled
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Selecione um instrutor primeiro...</option>
                        </select>
                    </div>

                    <!-- Vehicle Preferences Checkboxes -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="flex items-center gap-3 p-4 border rounded-lg hover:bg-white transition-all cursor-pointer">
                            <input type="checkbox" name="prefer_dual_control" id="id_prefer_dual_control" class="h-4 w-4 text-primary border-gray-300 rounded">
                            <span class="text-sm text-gray-700">Preferir acionamento duplo<br><span class="text-xs text-gray-500">(pedais de parada no passageiro)</span></span>
                        </label>
                        <label class="flex items-center gap-3 p-4 border rounded-lg hover:bg-white transition-all cursor-pointer">
                            <input type="checkbox" name="prefer_adapted_pcd" id="id_prefer_adapted_pcd" class="h-4 w-4 text-primary border-gray-300 rounded">
                            <span class="text-sm text-gray-700">Preferir adaptado para PCD<br><span class="text-xs text-gray-500">(pessoas com defici√™ncia)</span></span>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                    <a href="{% url 'aluno_dashboard' %}" 
                       class="px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-all">
                        Voltar
                    </a>
                    <button type="button" 
                            id="preview-btn"
                            class="px-6 py-3 gradient-primary text-white font-medium rounded-lg hover:opacity-90 transition-all shadow-card flex items-center gap-2">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Confirmar Agendamento
                    </button>
                </div>
            </form>
        </div>

        <!-- Summary Modal -->
        <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-screen overflow-y-auto">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Resumo do Agendamento
                    </h2>
                    <p class="text-blue-100 mt-1">Verifique suas informa√ß√µes antes de confirmar</p>
                </div>

                <!-- Modal Content -->
                <div class="p-6 space-y-6">
                    <!-- Date & Time -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-xs text-gray-600 uppercase font-semibold mb-1">Data</p>
                            <p class="text-lg font-bold text-gray-900" id="summary-date">-</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-xs text-gray-600 uppercase font-semibold mb-1">Hor√°rio</p>
                            <p class="text-lg font-bold text-gray-900" id="summary-time">-</p>
                        </div>
                    </div>

                    <!-- Instructor -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-1">üë®‚Äçüè´ Instrutor</p>
                        <p class="text-lg font-bold text-gray-900" id="summary-instructor">-</p>
                        <p class="text-xs text-gray-600 mt-2">Prefer√™ncia de Instrutor: <span class="text-gray-900" id="summary-instructor-pref">Indiferente</span></p>
                    </div>

                    <!-- Vehicle Type & Model -->
                    <div class="space-y-3">
                        <div class="bg-green-50 rounded-lg p-4">
                            <p class="text-xs text-gray-600 uppercase font-semibold mb-1">üöó Tipo de Ve√≠culo</p>
                            <p class="text-lg font-bold text-gray-900" id="summary-vehicle-type">-</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <p class="text-xs text-gray-600 uppercase font-semibold mb-1">üèéÔ∏è Modelo do Ve√≠culo</p>
                            <p class="text-lg font-bold text-gray-900" id="summary-vehicle">Autoescola definir√°</p>
                            <p class="text-sm text-gray-600 mt-1" id="summary-vehicle-details"></p>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="bg-orange-50 rounded-lg p-4">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-2">üìç Local de Encontro</p>
                        <p class="text-sm text-gray-900">
                            <span id="summary-rua">-</span>, 
                            <span id="summary-numero">-</span><br>
                            <span id="summary-bairro">-</span> - 
                            <span id="summary-cidade">-</span>, 
                            <span id="summary-estado">-</span><br>
                            <span class="text-xs text-gray-600">CEP: <span id="summary-cep">-</span></span>
                        </p>
                    </div>

                    <!-- Preferences -->
                    <div class="bg-indigo-50 rounded-lg p-4">
                        <p class="text-xs text-gray-600 uppercase font-semibold mb-3">‚öôÔ∏è Prefer√™ncias</p>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2" id="summary-pref-dual">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <span class="text-gray-700">N√£o quer acionamento duplo</span>
                            </div>
                            <div class="flex items-center gap-2" id="summary-pref-pcd">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <span class="text-gray-700">N√£o quer adapta√ß√£o PCD</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-6 flex items-center justify-between gap-4">
                    <button type="button" 
                            id="cancel-summary-btn"
                            class="px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-all">
                        ‚Üê Voltar e Editar
                    </button>
                    <button type="button" 
                            id="confirm-summary-btn"
                            class="px-6 py-3 gradient-primary text-white font-medium rounded-lg hover:opacity-90 transition-all shadow-card flex items-center gap-2">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Confirmar e Agendar
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="mt-8 bg-white rounded-2xl p-6 shadow-card">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Informa√ß√µes Importantes
            </h3>
            <ul class="space-y-2 text-sm text-gray-600">
                <li>‚Ä¢ Conforme resolu√ß√£o CONTRAN, s√£o obrigat√≥rias 20 horas de aulas pr√°ticas</li>
                <li>‚Ä¢ Cada aula tem dura√ß√£o de 50 minutos</li>
                <li>‚Ä¢ Compare√ßa com 10 minutos de anteced√™ncia</li>
                <li>‚Ä¢ Traga documento de identifica√ß√£o e comprovante de matr√≠cula</li>
            </ul>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('agendamento-form');
    const previewBtn = document.getElementById('preview-btn');
    const summaryModal = document.getElementById('summary-modal');
    const cancelBtn = document.getElementById('cancel-summary-btn');
    const confirmBtn = document.getElementById('confirm-summary-btn');
    
    // CEP Lookup
    const cepInput = document.getElementById('id_cep');
    const searchCepBtn = document.getElementById('search-cep-btn');
    const cepErrorEl = document.getElementById('cep-error');
    const cepSuccessEl = document.getElementById('cep-success');
    const cepErrorMsg = document.getElementById('cep-error-msg');

    // Instructor Filter Elements
    const genderFilters = document.querySelectorAll('.gender-filter');
    const identityFilters = document.querySelectorAll('.identity-filter');
    const instructorSelect = document.getElementById('id_instructor');
    const vehicleSelect = document.getElementById('id_vehicle');
    const vehicleTypeSelect = document.getElementById('id_vehicle_type');

    let currentGender = '';
    let currentIdentity = '';
    let currentCEP = '';

    // Formatar CEP com h√≠fen
    function formatCEP(value) {
        value = value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.slice(0, 5) + '-' + value.slice(5, 8);
        }
        return value;
    }

    // Auto-format CEP input
    cepInput.addEventListener('input', function() {
        this.value = formatCEP(this.value);
    });

    // Gender filter buttons
    genderFilters.forEach(btn => {
        btn.addEventListener('click', function() {
            genderFilters.forEach(b => b.classList.remove('border-primary', 'bg-primary', 'text-white'));
            this.classList.add('border-primary', 'bg-primary', 'text-white');
            currentGender = this.getAttribute('data-gender');
            // Reset identity selection when binary gender changes
            identityFilters.forEach(b => b.classList.remove('border-primary', 'bg-primary', 'text-white'));
            currentIdentity = '';
            
            if (currentCEP) {
                loadInstructors();
            }
        });
    });

    // Identity filter buttons (maps to binary gender for API)
    identityFilters.forEach(btn => {
        btn.addEventListener('click', function() {
            identityFilters.forEach(b => b.classList.remove('border-primary', 'bg-primary', 'text-white'));
            this.classList.add('border-primary', 'bg-primary', 'text-white');
            currentIdentity = this.getAttribute('data-identity');
            // Map identity to M/F for filtering
            currentGender = this.getAttribute('data-map') || '';
            // Reflect mapped gender selection visually
            genderFilters.forEach(b => {
                const g = b.getAttribute('data-gender');
                b.classList.toggle('border-primary', g === currentGender);
                b.classList.toggle('bg-primary', g === currentGender);
                b.classList.toggle('text-white', g === currentGender);
            });
            if (currentCEP) {
                loadInstructors();
            }
        });
    });

    // Search CEP
    searchCepBtn.addEventListener('click', function() {
        const cepValue = cepInput.value.trim();
        
        if (!cepValue || cepValue.length !== 9) {
            showCepError('CEP inv√°lido. Use o formato: 00000-000');
            return;
        }

        searchCepBtn.disabled = true;
        searchCepBtn.innerHTML = '<svg class="h-4 w-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Buscando...';
        cepErrorEl.classList.add('hidden');
        cepSuccessEl.classList.add('hidden');

        fetch(`/api/lookup-cep/?cep=${encodeURIComponent(cepValue)}`)
            .then(response => response.json())
            .then(data => {
                searchCepBtn.disabled = false;
                searchCepBtn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg> Buscar';
                
                if (data.success) {
                    document.getElementById('id_rua').value = data.rua;
                    document.getElementById('id_bairro').value = data.bairro;
                    document.getElementById('id_cidade').value = data.cidade;
                    document.getElementById('id_estado').value = data.estado;
                    cepInput.value = data.cep;
                    
                    currentCEP = data.cep.replace('-', '');
                    
                    cepErrorEl.classList.add('hidden');
                    cepSuccessEl.classList.remove('hidden');
                    document.getElementById('id_numero').focus();
                    
                    // Carrega instrutores baseado no CEP e g√™nero
                    loadInstructors();
                } else {
                    showCepError(data.error || 'CEP n√£o encontrado');
                }
            })
            .catch(error => {
                searchCepBtn.disabled = false;
                searchCepBtn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg> Buscar';
                showCepError('Erro ao buscar CEP. Tente novamente.');
                console.error('CEP lookup error:', error);
            });
    });

    // Allow Enter key to search CEP
    cepInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchCepBtn.click();
        }
    });

    function showCepError(message) {
        cepErrorMsg.textContent = message;
        cepErrorEl.classList.remove('hidden');
        cepSuccessEl.classList.add('hidden');
    }

    // Carrega instrutores baseado em CEP e g√™nero
    function loadInstructors() {
        const params = new URLSearchParams({
            cep: currentCEP,
            gender: currentGender
        });

        instructorSelect.disabled = true;
        instructorSelect.innerHTML = '<option value="">Carregando instrutores...</option>';

        fetch(`/api/filter-instructors/?${params}`)
            .then(response => response.json())
            .then(data => {
                instructorSelect.disabled = false;
                instructorSelect.innerHTML = '<option value="">Selecione um instrutor</option>';

                if (data.instructors && data.instructors.length > 0) {
                    data.instructors.forEach(instructor => {
                        const option = document.createElement('option');
                        option.value = instructor.id;
                        const genderLabel = instructor.gender_code ? (instructor.gender_code === 'M' ? 'üë®' : 'üë©') : '';
                        const identityLabel = instructor.gender_identity_label ? ` ‚Ä¢ ${instructor.gender_identity_label}` : '';
                        const ratingLabel = instructor.rating ? ` ‚≠ê ${instructor.rating}` : ' ‚≠ê Novo';
                        option.textContent = `${genderLabel} ${instructor.name}${identityLabel}${ratingLabel}`;
                        instructorSelect.appendChild(option);
                    });
                } else {
                    instructorSelect.innerHTML = '<option value="">Nenhum instrutor encontrado nesta regi√£o</option>';
                }
            })
            .catch(error => {
                instructorSelect.disabled = false;
                instructorSelect.innerHTML = '<option value="">Erro ao carregar instrutores</option>';
                console.error('Instructor filter error:', error);
            });
    }

    // Quando instrutor √© selecionado, carrega seus ve√≠culos
    instructorSelect.addEventListener('change', function() {
        if (!this.value) {
            vehicleSelect.disabled = true;
            vehicleSelect.innerHTML = '<option value="">Selecione um instrutor primeiro...</option>';
            return;
        }

        vehicleSelect.disabled = true;
        vehicleSelect.innerHTML = '<option value="">Carregando ve√≠culos...</option>';

        const params = new URLSearchParams({
            instructor_id: this.value,
            vehicle_type: vehicleTypeSelect.value || '',
            prefer_dual: document.getElementById('id_prefer_dual_control').checked,
            prefer_pcd: document.getElementById('id_prefer_adapted_pcd').checked
        });

        fetch(`/api/filter-vehicles/?${params}`)
            .then(response => response.json())
            .then(data => {
                vehicleSelect.disabled = false;
                vehicleSelect.innerHTML = '<option value="">Qualquer modelo dispon√≠vel</option>';

                if (data.vehicles && data.vehicles.length > 0) {
                    data.vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.id;
                        let display = `${vehicle.make} ${vehicle.model} (${vehicle.year})`;
                        if (vehicle.dual_control) display += ' ‚Ä¢ Duplo';
                        if (vehicle.adapted_pcd) display += ' ‚Ä¢ PCD';
                        option.textContent = display;
                        vehicleSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                vehicleSelect.disabled = false;
                vehicleSelect.innerHTML = '<option value="">Erro ao carregar ve√≠culos</option>';
                console.error('Vehicle filter error:', error);
            });
    });

    // Quando prefer√™ncias mudam, recarrega ve√≠culos
    document.getElementById('id_prefer_dual_control').addEventListener('change', () => {
        if (instructorSelect.value) {
            instructorSelect.dispatchEvent(new Event('change'));
        }
    });

    document.getElementById('id_prefer_adapted_pcd').addEventListener('change', () => {
        if (instructorSelect.value) {
            instructorSelect.dispatchEvent(new Event('change'));
        }
    });

    vehicleTypeSelect.addEventListener('change', () => {
        if (instructorSelect.value) {
            instructorSelect.dispatchEvent(new Event('change'));
        }
    });

    // Formatar data para exibi√ß√£o
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Formatar tipo de ve√≠culo
    function getVehicleTypeLabel(type) {
        const types = {
            'A': 'üèçÔ∏è Categoria A - Motocicleta',
            'B': 'üöó Categoria B - Carro'
        };
        return types[type] || type;
    }

    // Preencher resumo
    function populateSummary() {
        // Data e Hora
        const dateInput = document.getElementById('id_date');
        const timeInput = document.getElementById('id_time');
        document.getElementById('summary-date').textContent = formatDate(dateInput.value);
        document.getElementById('summary-time').textContent = timeInput.value || '-';

        // Instrutor
        const instructorOption = instructorSelect.options[instructorSelect.selectedIndex];
        document.getElementById('summary-instructor').textContent = instructorOption.text || '-';

        // Tipo de Ve√≠culo
        document.getElementById('summary-vehicle-type').textContent = getVehicleTypeLabel(vehicleTypeSelect.value);

        // Modelo de Ve√≠culo
        const vehicleOption = vehicleSelect.options[vehicleSelect.selectedIndex];
        if (vehicleSelect.value) {
            document.getElementById('summary-vehicle').textContent = vehicleOption.text || 'Ve√≠culo';
            document.getElementById('summary-vehicle-details').textContent = '';
        } else {
            document.getElementById('summary-vehicle').textContent = 'Autoescola definir√°';
            document.getElementById('summary-vehicle-details').textContent = '';
        }

        // Localiza√ß√£o (CEP)
        const cepInput = document.getElementById('id_cep');
        const ruaInput = document.getElementById('id_rua');
        const numeroInput = document.getElementById('id_numero');
        const bairroInput = document.getElementById('id_bairro');
        const cidadeInput = document.getElementById('id_cidade');
        const estadoInput = document.getElementById('id_estado');

        document.getElementById('summary-cep').textContent = cepInput.value || '-';
        document.getElementById('summary-rua').textContent = ruaInput.value || '-';
        document.getElementById('summary-numero').textContent = numeroInput.value || '-';
        document.getElementById('summary-bairro').textContent = bairroInput.value || '-';
        document.getElementById('summary-cidade').textContent = cidadeInput.value || '-';
        document.getElementById('summary-estado').textContent = estadoInput.value || '-';

        // Prefer√™ncias
        const dualControl = document.getElementById('id_prefer_dual_control').checked;
        const adaptedPcd = document.getElementById('id_prefer_adapted_pcd').checked;

        const dualPrefEl = document.getElementById('summary-pref-dual');
        const pcdPrefEl = document.getElementById('summary-pref-pcd');

        if (dualControl) {
            dualPrefEl.innerHTML = '<svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg><span class="text-gray-900 font-medium">Preferir acionamento duplo</span>';
        } else {
            dualPrefEl.innerHTML = '<svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span class="text-gray-700">Sem prefer√™ncia por acionamento duplo</span>';
        }

        if (adaptedPcd) {
            pcdPrefEl.innerHTML = '<svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg><span class="text-gray-900 font-medium">Preferir ve√≠culo adaptado para PCD</span>';
        } else {
            pcdPrefEl.innerHTML = '<svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span class="text-gray-700">Sem prefer√™ncia por adapta√ß√£o PCD</span>';
        }

        // Prefer√™ncia de g√™nero/identidade (exibi√ß√£o)
        const summaryInstructorPref = document.getElementById('summary-instructor-pref');
        if (summaryInstructorPref) {
            let prefText = 'Indiferente';
            if (currentIdentity) {
                const identityMap = {
                    'CF': 'Cisg√™nero Feminino',
                    'CM': 'Cisg√™nero Masculino',
                    'TM': 'Homem Transg√™nero',
                    'TW': 'Mulher Transg√™nero'
                };
                prefText = identityMap[currentIdentity] || prefText;
            } else if (currentGender === 'M') {
                prefText = 'Masculino';
            } else if (currentGender === 'F') {
                prefText = 'Feminino';
            }
            summaryInstructorPref.textContent = prefText;
        }
    }

    // Abrir modal de resumo
    previewBtn.addEventListener('click', function(e) {
        e.preventDefault();

        // Validar formul√°rio
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        populateSummary();
        summaryModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    // Fechar modal
    cancelBtn.addEventListener('click', function() {
        summaryModal.classList.add('hidden');
        document.body.style.overflow = '';
    });

    // Confirmar agendamento
    confirmBtn.addEventListener('click', function() {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<svg class="h-4 w-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Processando...';
        form.submit();
    });

    // Fechar modal ao clicar fora
    summaryModal.addEventListener('click', function(e) {
        if (e.target === summaryModal) {
            summaryModal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    });
});
</script>
{% endblock %}
